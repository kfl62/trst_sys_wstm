:ruby
  firm    = Wstm::PartnerFirm.find_by(firm: true)
  today   = Date.today
  y       = params[:p_y].nil? ? today.year  : params[:p_y].to_i
  m       = params[:p_m].nil? ? today.month : params[:p_m].to_i
  dln_ary = params[:dln_ary] == 'true' ? [] : params[:dln_ary].split(',') if params[:dln_ary]
  grn_ary = params[:grn_ary] == 'true' ? [] : params[:grn_ary].split(',') if params[:grn_ary]
  bckgrnd = {"afdv" => "#FFBFF0","dpoa" => "#FFBFF0","ca21" => "#DDDDDD","cb25" => "#DDDDDD","sa57" => "#FFFF99","o139" => "#FFFF99","r25b" => "#BFFFBF","rafn" => "#BFFFBF"}
- if params[:grn_ary]
  %span#hidden_data{data: {dialog: "filter",title_data: mat(@object,'model_name_grn'),model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_invoice'}}
  %article#xhr_info.info
    %i.fa.fa-info-circle.fa-lg.blue
    = t('intro.filter.desk_invoice.grn')
  %form{action: "/sys/#{@path}", method: 'get'}
    %table
      %thead
        = partial 'wstm/shared/select_params', locals: {colspan: '5', p03: (0..3)}
        %tr.pdb-05
          %td
            %input#supplr_id.param.select2{name: 'supplr_id', type: 'hidden', style: 'width:200px', data: {minlength: '2',ph: '3',search: 'Wstm::PartnerFirm'}}
            %input#supplr_d_id.select2{type: 'hidden', style: 'width:200px', data: {minlength: '0',ph: '1',search: 'Wstm::PartnerFirm'}}
            %button#supplr_d{type: "button", data: {action: "create", icon: "fa fa-plus-square-o"}}=  t('button.create') + " Delegat!"
        - if params[:p03] && params[:supplr_id]
          - if params[:p03] == 'mixt'
            - grns = Wstm::Grn.monthly(y,m).charged(false).where(supplr_id: params[:supplr_id],doc_type: 'DN').asc(:doc_name)
          - else
            - grns = Wstm::Grn.monthly(y,m).charged(false).by_p03(params[:p03].to_bool).where(supplr_id: params[:supplr_id],doc_type: 'DN').asc(:doc_name)
          - if grns.empty?
            %tr.grns
              %td
                %detail.detail
                  %i.fa.fa-info-circle.fa-lg.blue
                  = t('intro.filter.desk_invoice.no_grn')
          - else
            %tr.grns.pdb-05
              %td
                %span{style: 'display:inline-block'}
                  - grns.each_with_index do |grn,i|
                    %label{style: "border-right: solid 1px #333333;padding-right: 3px;cursor: pointer;background-color: #e6e6e6;display: inline-block",
                           title: "#{grn.id_date}\n#{grn.name}\n#{grn.freights_list.join("\n")}"}
                      %input.grn_ary{id:grn.id,type: 'checkbox',checked: grn_ary.include?(grn.id.to_s)}
                      = grn.doc_name
            %tr.grns.pdb-05
              %td
                %span= t('intro.filter.desk_invoice.hover')
        %tbody
          - unless grn_ary.empty?
            %tr.grns
              %td
                %table.inner
                  %tbody.inner
                    %tr
                      - mat(@object,'table_header_grn').each do |label|
                        %td= label
                    - data = Wstm::Grn.where(:id.in => grn_ary).sum_freights_grn; data.sort.each do |s|
                      %tr
                        %td
                          %span.stats= s[1][0]
                        %td.ta-ce.w-4rem
                          %span.um kg
                        %td.ta-ri.w-8rem
                          %span.pu= "%.2f" % s[1][2]
                        %td.ta-ri.w-8rem
                          %span.qu= "%.2f" % s[1][3]
                        %td.ta-ri.w-8rem
                          %span.val= "%.2f" % s[1][4]
                    %tr.result
                      %td{:colspan => "3"}
                        %span Total
                      %td
                        %span= "%.2f" % data.values.sum{|r| r[3]}
                      %td
                        %span= "%.2f" % data.values.sum{|r| r[4]}
      %tfoot
        %tr
          - td_buttonset(['create','cancel'],{style: 'ta-ce', create: {text: t('button.create') + " Facură!"}})
- elsif params[:dln_ary]
  %span#hidden_data{data: {dialog: "filter",model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_invoice'}}
  %article#xhr_info.info
    %i.fa.fa-info-circle.fa-lg.blue
    = t('intro.filter.desk_invoice.main')
  %form{action: "/sys/#{@path}", method: 'get'}
    %table
      %thead
        = partial 'wstm/shared/select_params', locals: {colspan: '5', p03: (0..2)}
        %tr.pdb-05
          %td
            %input#client_id.param.select2{name: 'client_id',type: 'hidden', style: 'width:200px', data: {minlength: '2',ph: '0',search: 'Wstm::PartnerFirm'}}
            %input#client_d_id.select2{type: 'hidden', style: 'width:200px', data: {minlength: '0',ph: '1',search: 'Wstm::PartnerFirm'}}
            %button#client_d{type: "button", data: {action: "create", icon: "fa fa-plus-square-o"}}=  t('button.create') + " Delegat!"
        - if params[:p03] && params[:client_id]
          - dlns = Wstm::DeliveryNote.monthly(y,m).charged(false).by_p03(params[:p03].to_bool).where(:client_id  => params[:client_id])
          - if dlns.empty?
            %tr.dlns.pdb-05
              %td
                %detail.detail
                  %i.fa.fa-info-circle.fa-lg.blue
                  = t('intro.filter.desk_invoice.no_dln')
          - else
            %tr.dlns.pdb-05
              %td
                %span.width-500{style: 'display:inline-block'}
                  - dlns.each_with_index do |dln,i|
                    %label{style: "border-right: solid 1px #333333;padding-right: 3px;cursor: pointer;background-color: #{bckgrnd[dln.name.split('_')[1].downcase]};display:inline-block",
                           title: "#{dln.id_date}\n#{dln.name}\n#{dln.freights_list.join("\n")}"}
                      %input.dln_ary{id:dln.id,type: 'checkbox',checked: dln_ary.include?(dln.id.to_s)}
                      = dln.doc_name
            %tr.dlns.pdb-05
              %td
                %span= t('intro.filter.desk_invoice.legend')
                - firm.units.asc(:slug).each do |u|
                  %span.small{style: "background-color: #{bckgrnd[u.name[0].downcase]}",title: "#{u.name[1]}"}= u.name[0]
                %br
                %span= t('intro.filter.desk_invoice.hover')
        %tbody
          - unless dln_ary.empty?
            %tr.dlns
              %td
                %table.inner
                  %tbody.inner
                    %tr
                      - mat(@object,'table_header').each do |label|
                        %td= label
                    - data = Wstm::DeliveryNote.where(:id.in => dln_ary).sum_freights_inv; data.sort.each do |s|
                      %tr
                        %td
                          %span= s[1][0]
                        %td.ta-ce.w-4rem
                          %span kg
                        %td.ta-ri.w-8rem
                          %span= "%.2f" % s[1][2]
                        %td.ta-ri.w-8rem
                          %span= "%.2f" % s[1][3]
                        %td.ta-ri.w-8rem
                          %span= "%.4f" % s[1][4]
                        %td.ta-ri.w-8rem
                          %span= "%.2f" % s[1][5]
                    %tr.result
                      %td{:colspan => "2"}= "Total"
                      %td
                        %span= "%.2f" % data.values.sum{|r| r[2]}
                      %td
                        %span= "%.2f" % data.values.sum{|r| r[3]}
                      %td
                        %span
                      %td
                        %span= "%.2f" % data.values.sum{|r| r[5]}
      %tfoot
        %tr
          - td_buttonset(['create','cancel'],{style: 'ta-ce', create: {text: t('button.create') + " Facură!"}})
- elsif params[:inv_ary] == 'payable'
  %span#hidden_data{data: {dialog: "filter",title_data:mat(@object,'title_data_payable'),model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_payment'}}
  %form{action: "/sys/#{@path}", method: 'get'}
    %table
      %thead
        %tr.pdb-05
          %td
            %detail.detail
              %i.fa.fa-info-circle.fa-lg.blue
              = t('intro.filter.not_ready')
      %tbody
      %tfoot
        %tr
          - td_buttonset(['cancel'],{style: 'ta-ce', create: {text: t('button.create') + " NIR!"}})
- elsif params[:inv_ary] == 'receivable'
  %span#hidden_data{data: {dialog: "filter",title_data:mat(@object,'title_data_receivable'),model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_payment'}}
  %form{action: "/sys/#{@path}", method: 'get'}
    %table
      %thead
        %tr.pdb-05
          %td
            %detail.detail
              %i.fa.fa-info-circle.fa-lg.blue
              = t('intro.filter.not_ready')
      %tbody
      %tfoot
        %tr
          - td_buttonset(['cancel'],{style: 'ta-ce', create: {text: t('button.create') + " NIR!"}})
- else
  %span#hidden_data{data: {dialog: "filter",model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_payment'}}
  %form{action: "/sys/#{@path}", method: 'get'}
    %table
      %thead
        %tr.pdb-05
          %td
            %detail.detail
              %i.fa.fa-info-circle.fa-lg.blue
              = t('intro.filter.not_ready')
      %tbody
      %tfoot
        %tr
          - td_buttonset(['cancel'],{style: 'ta-ce', create: {text: t('button.create') + " NIR!"}})
