:ruby
  today = Date.today;   cols = 0
  y   = params[:y].nil? ? today.year  : params[:y].to_i
  m   = params[:m].nil? ? today.month : params[:m].to_i
  uid = @current_user.unit_id ? @current_user.unit_id : params[:uid] == 'null' ? nil : params[:uid]
  fid = params[:fid] ? params[:fid] == 'null' ? nil : params[:fid] : nil
  firm= Wstm::PartnerFirm.find_by(firm: :true); unit= firm.units.find(uid) if uid; freight = Wstm::Freight.find(fid) if fid
  data= uid ? unit.name[1] : firm.name[2]
%span#hidden_data.hidden{data: {dialog: "query",title_data: data,model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_freight'}}
- if uid && fid.nil?
  %div.small
    %p.noFreight
      %select#y
        - [2011,2012].each do |year|
          %option{value: year, selected: y == year}= year
      %select#m
        - t('month')[1..12].each_with_index do |month,i|
          %option{value: i + 1, selected: m == i + 1}= month
      - if @current_user.unit_id
        %span= l(today, format: :trst) if m == today.month
      - else
        %select#u
          %option{value: 'null'} Toate unităţile
          - firm.units.asc(:slug).each do |pos|
            %option{value: pos.id, selected: uid.to_s == pos.id.to_s}= pos.name[1]
    %span.info= t('intro.query.desk_freight.one')
  %table{:cellspacing => "0"}
    %tbody.inner
      %tr
        - mat(@object,'table_all').each do |cn|; cols += 1
          %td
            %span.stats.ce= cn
      - unit.freights.stats_pos(y,m).each do |st|
        %tr
          %td
            %span.stats.link{id: st.shift}= st.shift
          - st.each do |s|
            %td
              %span.stats.ri= "%0.2f" % s
      %tr
        %td{colspan: cols} &nbsp;
- elsif freight
  %div.small
    %span.info= t('intro.query.desk_freight.exit_one')
    %p.hasFreight
      %select#y
        - [2011,2012].each do |year|
          %option{value: year, selected: y == year}= year
      %select#m
        - t('month')[1..12].each_with_index do |month,i|
          %option{value: i + 1, selected: m == i + 1}= month
      %select#f{data: {uid: freight.unit.id}}
        %option{value: 'null'}= t('select.freight_all')
        - freight.unit.freights.asc(:id_stats).each do |f|
          %option{value: f.id, selected: freight.id.to_s == f.id.to_s}= f.name
  %table
    %tbody.inner.stats
      %tr
        - mat(@object,'table_one').each do |cn|
          %td
            %span.stats.ce= cn
      %tr
        %td{:colspan => "3"}
          %span.stats.ce= mat(@object,'stock_start')
        %td
          %span.stats.ri= "%0.2f" % freight.stks.sum_stks(y,m)
      - data = @object.stats_one(fid,y,m); data.each do |d|
        %tr
          %td
            %span.stats= d.shift
          - d.each do |v|
            %td
              %span.stats.ri= "%0.2f" % v
- else
  %div.small
    %span.info.width-500.ju= t('intro.query.desk_freight.all')
    %p.noFreight
      %select#y
        - [2011,2012].each do |year|
          %option{value: year, selected: y == year}= year
      %select#m
        - t('month')[1..12].each_with_index do |month,i|
          %option{value: i + 1, selected: m == i + 1}= month
  %table{:cellspacing => "0"}
    %tbody.inner
      %tr
        - mat(@object,'table_all').each do |cn|; cols += 1
          %td
            %span.stats.ce= cn
        - firm.units.asc(:slug).each do |cn|; cols +=1
          %td
            %span.stats.ce.link.uid{id: cn.id}= cn.slug
      - @object.stats_all(y,m).each do |st|
        %tr
          %td
            %span.stats= st.shift
          - dif = st.pop
          - st.each_with_index do |c,i|
            %td
              - if i == 3
                - if firm.name[0] == 'Diren'
                  %span.stats.ri.st{:title => dif != 0 &&  "Transfer intern neoperat:\n\t%0.2f kg\nlipseşte la stoc DPOA!" % dif, :style =>  dif != 0 && 'color:red;cursor:pointer'}= "%0.2f" % c
                - else
                  %span.stats.ri.st= "%0.2f" % (c - dif)
              - else
                %span.stats.ri=  "%0.2f" % c
      %tr
        %td{colspan: cols} &nbsp;
