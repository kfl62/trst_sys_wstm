:ruby
  today = Date.today;   cols = 0
  y   = params[:p_y].nil? ? today.year  : params[:p_y].to_i
  m   = params[:p_m].nil? ? today.month : params[:p_m].to_i
  uid = @current_user.unit_id ? @current_user.unit_id : params[:uid] == 'null' ? nil : params[:uid]
  firm= Wstm::PartnerFirm.find_by(firm: :true); unit= firm.units.find(uid) if uid
  data= uid ? unit.name[1] : firm.name[2]
%span#hidden_data{data: {dialog: "query",title_data: data,model_name: mat(@object,'model_name'),oid: "null",js_ext: 'desk_cache'}}
- if uid
  %article#xhr_info.info
    %i.fa.fa-info-circle.fa-lg.blue
    = t('intro.query.desk_cache.one')
  %table{:cellspacing => "0"}
    %thead
      = partial "#{@path}/query_params", locals: {firm: firm, colspan: '4'}
    %tbody.inner
      %tr
        - mat(@object,'table_one').each do |cn|
          %td
            %span.stats.ce= cn
      %tr
        %td.ta-ce{colspan: '3'}
          %span= mat(@object,'stock_start')
        %td.ta-ri
          %span= "%0.2f" % @object.by_unit_id(uid).sum_mny(y,m,mny: [:money_stock]).first
      - @object.stats_pos(uid,y,m,mny_all:true,exp_all: false).each do |r|
        - dif = r.delete_at(2); r.delete_at(-2)
        %tr
          %td
            %span= r.shift
          - r.each_with_index do |c,i|
            %td.ta-ri
              %span= "%0.2f" % (i == 1 ?  c + dif : c)
- else
  %article#xhr_info.info
    %i.fa.fa-info-circle.fa-lg.blue
    = t('intro.query.desk_cache.all')
  %table{:cellspacing => "0"}
    %thead
      = partial "#{@path}/query_params", locals: {colspan: '5'}
    %tbody.inner
      %tr
        - mat(@object,'table_all').each do |cn|
          %td
            %span= cn
      - @object.stats_all(y,m,mny_all: true,ext_all: false).each do |r|
        - dif = r.delete_at(4); r.delete_at(-2)
        %tr
          %td
            %span{id: (r[0] != 'Total') && r.shift, class: (r[0] != 'Total') && 'link'}= r.shift
          - r.each_with_index do |c,i|
            %td.ta-ri
              %span= "%0.2f" % (i == 2 ?  c + dif : c)
